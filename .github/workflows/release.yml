name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md
          else
            git log --pretty=format:"- %s (%h)" >> CHANGELOG.md
          fi

          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Installation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "Download the appropriate binary for your platform from the assets below." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Verify checksums" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "sha256sum -c ananke-${VERSION}-checksums.txt" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'rc') }}
          generate_release_notes: true

  build-release:
    name: Build Release Binaries
    needs: create-release
    strategy:
      matrix:
        include:
          # Linux builds
          - target: x86_64-linux
            os: ubuntu-latest
            artifact_name: ananke
            asset_name: ananke-linux-x86_64
            rust_target: x86_64-unknown-linux-gnu
            lib_ext: so
          - target: aarch64-linux
            os: ubuntu-latest
            artifact_name: ananke
            asset_name: ananke-linux-aarch64
            rust_target: aarch64-unknown-linux-gnu
            lib_ext: so

          # macOS builds
          - target: x86_64-macos
            os: macos-latest
            artifact_name: ananke
            asset_name: ananke-macos-x86_64
            rust_target: x86_64-apple-darwin
            lib_ext: dylib
          - target: aarch64-macos
            os: macos-latest
            artifact_name: ananke
            asset_name: ananke-macos-aarch64
            rust_target: aarch64-apple-darwin
            lib_ext: dylib

          # Windows builds
          - target: x86_64-windows
            os: windows-latest
            artifact_name: ananke.exe
            asset_name: ananke-windows-x86_64
            rust_target: x86_64-pc-windows-msvc
            lib_ext: dll

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: '0.15.2'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            maze/target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Zig binary
        run: |
          zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseFast

      - name: Build Zig static library
        run: |
          zig build-lib -static -O ReleaseFast src/ffi/zig_ffi.zig -femit-bin=libananke.a

      - name: Build Rust Maze library
        working-directory: maze
        run: |
          cargo build --release --target ${{ matrix.rust_target }}

      - name: Create release package structure
        shell: bash
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          PKG_NAME="ananke-${VERSION}-${{ matrix.asset_name }}"
          mkdir -p ${PKG_NAME}/{bin,lib,include,examples,docs}

          # Copy Zig binary
          cp zig-out/bin/${{ matrix.artifact_name }} ${PKG_NAME}/bin/

          # Copy Zig static library
          cp libananke.a ${PKG_NAME}/lib/

          # Copy Rust Maze library
          if [ -f maze/target/${{ matrix.rust_target }}/release/libmaze.${{ matrix.lib_ext }} ]; then
            cp maze/target/${{ matrix.rust_target }}/release/libmaze.${{ matrix.lib_ext }} ${PKG_NAME}/lib/
          elif [ -f maze/target/${{ matrix.rust_target }}/release/maze.${{ matrix.lib_ext }} ]; then
            cp maze/target/${{ matrix.rust_target }}/release/maze.${{ matrix.lib_ext }} ${PKG_NAME}/lib/
          fi

          # Copy FFI headers (create if missing)
          if [ -f src/ffi/ananke.h ]; then
            cp src/ffi/ananke.h ${PKG_NAME}/include/
          else
            touch ${PKG_NAME}/include/ananke.h
          fi

          # Copy examples
          cp -r examples/*.zig ${PKG_NAME}/examples/ 2>/dev/null || true

          # Copy documentation
          cp README.md ${PKG_NAME}/ 2>/dev/null || touch ${PKG_NAME}/README.md
          cp LICENSE* ${PKG_NAME}/ 2>/dev/null || touch ${PKG_NAME}/LICENSE
          cp QUICKSTART.md ${PKG_NAME}/docs/ 2>/dev/null || true

          # Create installation script
          cat > ${PKG_NAME}/install.sh <<'EOF'
          #!/bin/bash
          set -e
          PREFIX=${PREFIX:-/usr/local}
          echo "Installing Ananke to ${PREFIX}..."
          mkdir -p ${PREFIX}/{bin,lib,include}
          cp bin/ananke ${PREFIX}/bin/
          cp lib/* ${PREFIX}/lib/
          cp include/* ${PREFIX}/include/
          chmod +x ${PREFIX}/bin/ananke
          echo "Ananke installed successfully!"
          echo "Run 'ananke --version' to verify."
          EOF
          chmod +x ${PKG_NAME}/install.sh

          echo "PKG_NAME=${PKG_NAME}" >> $GITHUB_ENV

      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        run: |
          tar -czf ${PKG_NAME}.tar.gz ${PKG_NAME}
          sha256sum ${PKG_NAME}.tar.gz > ${PKG_NAME}.tar.gz.sha256

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          7z a ${env:PKG_NAME}.zip ${env:PKG_NAME}
          $hash = Get-FileHash ${env:PKG_NAME}.zip -Algorithm SHA256
          "$($hash.Hash.ToLower())  ${env:PKG_NAME}.zip" | Out-File -Encoding ASCII ${env:PKG_NAME}.zip.sha256

      - name: Upload Release Asset (Unix)
        if: runner.os != 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: |
            ${{ env.PKG_NAME }}.tar.gz
            ${{ env.PKG_NAME }}.tar.gz.sha256

      - name: Upload Release Asset (Windows)
        if: runner.os == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: |
            ${{ env.PKG_NAME }}.zip
            ${{ env.PKG_NAME }}.zip.sha256

  build-checksums:
    name: Generate Combined Checksums
    needs: [create-release, build-release]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate combined checksums
        run: |
          find . -name "*.sha256" -exec cat {} \; > ananke-${{ needs.create-release.outputs.version }}-checksums.txt
          cat ananke-${{ needs.create-release.outputs.version }}-checksums.txt

      - name: Upload checksums to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: ananke-${{ needs.create-release.outputs.version }}-checksums.txt

  publish-crate:
    name: Publish Maze to crates.io
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.create-release.outputs.version, 'alpha') && !contains(needs.create-release.outputs.version, 'beta') && !contains(needs.create-release.outputs.version, 'rc') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        working-directory: maze
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo publish --allow-dirty || echo "Already published or publish failed"

  publish-homebrew:
    name: Update Homebrew Formula
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.create-release.outputs.version, 'alpha') && !contains(needs.create-release.outputs.version, 'beta') && !contains(needs.create-release.outputs.version, 'rc') }}

    steps:
      - name: Download macOS artifacts for checksums
        uses: actions/download-artifact@v4
        with:
          pattern: ananke-*-macos-*.tar.gz.sha256

      - name: Generate Homebrew Formula
        shell: bash
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          VERSION_NUM=${VERSION#v}

          # Find checksum files
          SHA256_X86=$(cat ananke-${VERSION}-macos-x86_64.tar.gz.sha256 2>/dev/null | cut -d' ' -f1 || echo "PLACEHOLDER")
          SHA256_ARM=$(cat ananke-${VERSION}-macos-aarch64.tar.gz.sha256 2>/dev/null | cut -d' ' -f1 || echo "PLACEHOLDER")

          cat > homebrew-ananke.rb <<EOF
          class Ananke < Formula
            desc "Constraint-driven code generation system"
            homepage "https://github.com/${{ github.repository }}"
            version "${VERSION_NUM}"
            license "MIT OR Apache-2.0"

            on_macos do
              if Hardware::CPU.intel?
                url "https://github.com/${{ github.repository }}/releases/download/${VERSION}/ananke-${VERSION}-macos-x86_64.tar.gz"
                sha256 "${SHA256_X86}"
              elsif Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/${VERSION}/ananke-${VERSION}-macos-aarch64.tar.gz"
                sha256 "${SHA256_ARM}"
              end
            end

            on_linux do
              if Hardware::CPU.intel?
                url "https://github.com/${{ github.repository }}/releases/download/${VERSION}/ananke-${VERSION}-linux-x86_64.tar.gz"
              end
            end

            def install
              bin.install "ananke-${VERSION}-*/bin/ananke" => "ananke"
              lib.install Dir["ananke-${VERSION}-*/lib/*"]
              include.install Dir["ananke-${VERSION}-*/include/*"]
              doc.install "ananke-${VERSION}-*/README.md"
            end

            test do
              assert_match "Ananke v", shell_output("#{bin}/ananke --version")
            end
          end
          EOF

          cat homebrew-ananke.rb

      - name: Upload Formula as Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: homebrew-ananke.rb

      - name: Instructions
        run: |
          echo "To publish to Homebrew:"
          echo "1. Create a tap repository: homebrew-ananke"
          echo "2. Copy homebrew-ananke.rb to the tap repository as Formula/ananke.rb"
          echo "3. Commit and push to publish"
          echo ""
          echo "Release version: ${{ needs.create-release.outputs.version }}"

  publish-aur:
    name: Update AUR Package
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.create-release.outputs.version, 'alpha') && !contains(needs.create-release.outputs.version, 'beta') && !contains(needs.create-release.outputs.version, 'rc') }}

    steps:
      - name: Placeholder for AUR update
        run: |
          echo "To publish to AUR:"
          echo "1. Create AUR package repository"
          echo "2. Update PKGBUILD with new version and checksums"
          echo "3. Push to AUR"
          echo ""
          echo "Release version: ${{ needs.create-release.outputs.version }}"

  announce-release:
    name: Announce Release
    needs: [create-release, build-release, build-checksums]
    runs-on: ubuntu-latest

    steps:
      - name: Create announcement
        run: |
          echo "Release ${{ needs.create-release.outputs.version }} is now available!"
          echo ""
          echo "Download: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }}"
          echo ""
          echo "Add steps here to:"
          echo "- Post to Discord/Slack"
          echo "- Tweet announcement"
          echo "- Update documentation site"
          echo "- Send newsletter"
